/**
 * Created by Jigar Patel on 4/5/16.
 */
/**
 * Created by Jigar on 4/5/16.
 */

function BigMath() {
}

// Based on https://en.wikipedia.org/wiki/Sch%C3%B6nhage%E2%80%93Strassen_algorithm
BigMath.prototype.multiply = function (bignumber1, bignumber2) {
    var regex = /^\d+$/;
    if (!regex.test(bignumber1)) {
        throw bignumber1 + " is not a valid number";
    }
    if (!regex.test(bignumber2)) {
        throw bignumber2 + " is not a valid number";
    }
    var m = bignumber1.length;
    var n = bignumber2.length;
    var rows = [];
    var acs = m + n - 1;
    for (var i = bignumber2.length - 1; i >= 0; i--) {
        var ii = bignumber2.slice(i, i + 1);
        var ac = [];
        for (var j = bignumber1.length - 1; j >= 0; j--) {
            var jj = bignumber1.slice(j, j + 1);
            ac.push(ii * jj)
        }
        rows.push(ac);
    }

    var lc = [];
    for (var i = 0; i < acs; i++) {
        var sum = 0;
        for (var j = 0; j < rows.length; j++) {
            if ((i - j) >= 0) {
                if (rows[j][i - j] !== undefined) {
                    sum += rows[j][i - j];
                }
            }
        }
        lc.push(sum);
    }

    var result = "";
    var carry =0;
    for (var i = 0; i < lc.length; i++) {
        lc[i] = parseInt(carry) + parseInt(lc[i]);
        result = (lc[i] % 10).toString() + result;
        carry = Math.floor(lc[i]/10);
    }
    return result.toString();
};

function TUID () {
    this.tuid = null;
    this.tuidbase = null;
    this.millis = null;
    this.serverid = null;
    this.counter = null;
    this.shiftvalue = 262144;
}

TUID.prototype.isvalid = function (tuidString) {
    var tuidregex = /^\d{17,20}$/;
    return tuidregex.test(tuidString);
};

TUID.prototype.toUTCDateString = function () {
    var localDate = new Date(this.millis);
    return localDate.toUTCString();
};

TUID.prototype.toLocaleDateString = function () {
    var localDate = new Date(this.millis);
    return localDate.toString();
};

TUID.prototype.parse = function (tuidString) {
    if(!this.isvalid(tuidString)){
        throw "Invalid tuid string: " + tuidString;
    }
    this.tuid = tuidString;
    this.millis =  Math.floor(this.tuid / this.shiftvalue);
    var bm = new BigMath();
    this.tuidbase = bm.multiply(this.millis.toString(), this.shiftvalue.toString());
    return this;
};

TUID.prototype.generate = function (millis, serverid, counter) {
    this.millis = millis ;
    this.serverid = serverid;
    this.counter = counter;
    return this;
};


var testTuid  = function (millis, tuidbase, tuid, counter, serverid) {
    var t = new TUID();
    t.parse(tuid);
    // console.log(t);
    console.assert(t.tuid == tuid);
    console.assert(t.tuidbase == tuidbase);
    console.assert(t.millis == millis);
};

/*
 Millis         Tuidbase            Tuid                C   S
 1458630000000	382371102720000000	382371102720000000	0	0
 1458630000000	382371102720000000	382371102720000004	0	4
 1458630000000	382371102720000000	382371102720000008	0	8
 1458630000000	382371102720000000	382371102720000012	0	12
 1458630000000	382371102720000000	382371102720000016	0	16
 1458630000000	382371102720000000	382371102720000020	0	20
 1458630000000	382371102720000000	382371102720000024	0	24
 1458630000000	382371102720000000	382371102720000028	0	28
 1458630000000	382371102720000000	382371102720000032	0	32

 1458630000000	382371102720000000	382371102720003276	12	204
 1458630000000	382371102720000000	382371102720003280	12	208
 1458630000000	382371102720000000	382371102720003284	12	212

 1458630000000	382371102720000000	382371102720008260	32	68
 1458630000000	382371102720000000	382371102720008264	32	72
 1458630000000	382371102720000000	382371102720008268	32	76
 1458630000000	382371102720000000	382371102720008272	32	80
 1458630000000	382371102720000000	382371102720008276	32	84
 1458630000000	382371102720000000	382371102720008280	32	88
 1458630000000	382371102720000000	382371102720008284	32	92
 1458630000000	382371102720000000	382371102720008288	32	96

 1458630000000	382371102720000000	382371102720013316	52	4
 1458630000000	382371102720000000	382371102720013320	52	8
 1458630000000	382371102720000000	382371102720013324	52	12
 1458630000000	382371102720000000	382371102720013328	52	16
 1458630000000	382371102720000000	382371102720013332	52	20
 1458630000000	382371102720000000	382371102720013336	52	24
 1458630000000	382371102720000000	382371102720013340	52	28
 1458630000000	382371102720000000	382371102720013344	52	32
 1458630000000	382371102720000000	382371102720013348	52	36
 1458630000000	382371102720000000	382371102720013352	52	40
 1458630000000	382371102720000000	382371102720013356	52	44
 1458630000000	382371102720000000	382371102720013360	52	48
 1458630000000	382371102720000000	382371102720013364	52	52
 1458630000000	382371102720000000	382371102720013368	52	56
 1458702678713	382390155008540672	382390155008693272	596	24
 1458702678713	382390155008540672	382390155008693276	596	28
 1458702678713	382390155008540672	382390155008693280	596	32
 1458702678713	382390155008540672	382390155008693284	596	36
 1458702678713	382390155008540672	382390155008693288	596	40
 1458702678713	382390155008540672	382390155008693292	596	44
 1458702678713	382390155008540672	382390155008693296	596	48
 1458702678713	382390155008540672	382390155008693300	596	52
 1458702678713	382390155008540672	382390155008693304	596	56
 1458702678713	382390155008540672	382390155008693308	596	60

 1458702678713	382390155008540672	382390155008699408	620	16
 1458702678713	382390155008540672	382390155008699412	620	20
 1458702678713	382390155008540672	382390155008699416	620	24
 1458702678713	382390155008540672	382390155008699420	620	28
 1458702678713	382390155008540672	382390155008699424	620	32
 1458702678713	382390155008540672	382390155008699428	620	36
 1458702678713	382390155008540672	382390155008699432	620	40
 1458702678713	382390155008540672	382390155008699436	620	44
 1458702678713	382390155008540672	382390155008699440	620	48
 1458702678713	382390155008540672	382390155008699444	620	52
 1458702678713	382390155008540672	382390155008699448	620	56
 1458702678713	382390155008540672	382390155008699452	620	60

 1458702678713	382390155008540672	382390155008802004	1020	212
 1458702678713	382390155008540672	382390155008802008	1020	216
 1458702678713	382390155008540672	382390155008802012	1020	220
 1458702678713	382390155008540672	382390155008802016	1020	224
 1458702678713	382390155008540672	382390155008802020	1020	228
 1458702678713	382390155008540672	382390155008802024	1020	232
 1458702678713	382390155008540672	382390155008802028	1020	236
 1458702678713	382390155008540672	382390155008802032	1020	240
 1458702678713	382390155008540672	382390155008802036	1020	244
 1458702678713	382390155008540672	382390155008802040	1020	248
 1458702678713	382390155008540672	382390155008802044	1020	252

 */


var bm = new BigMath();
console.assert(bm.multiply("123456789", "12345"), "1524074060205");
console.assert(bm.multiply("1458702678713", "262144"), "382390155008540672");
/*

 3 2 1 9 8 7 6 5 4 3 2 1 0
 ----------------------------
 x x x x x x x x x | 0
 x x x x x x x x x   | 1
 x x x x x x x x x     | 2
 x x x x x x x x x       | 3
 x x x x x x x x x         | 4
 ----------------------------
 x
 */

testTuid('1458630000000','382371102720000000','382371102720000000' ,'0' ,'0');
testTuid('1458630000000','382371102720000000','382371102720000004' ,'0' ,'4');
testTuid('1458630000000','382371102720000000','382371102720000008' ,'0' ,'8');
testTuid('1458630000000','382371102720000000','382371102720000012' ,'0' ,'12');
testTuid('1458630000000','382371102720000000','382371102720000016' ,'0' ,'16');
testTuid('1458630000000','382371102720000000','382371102720000020' ,'0' ,'20');
testTuid('1458630000000','382371102720000000','382371102720000024' ,'0' ,'24');
testTuid('1458630000000','382371102720000000','382371102720000028' ,'0' ,'28');
testTuid('1458630000000','382371102720000000','382371102720000032' ,'0' ,'32');
testTuid('1458630000000','382371102720000000','382371102720003276' ,'12' ,'204');
testTuid('1458630000000','382371102720000000','382371102720003280' ,'12' ,'208');
testTuid('1458630000000','382371102720000000','382371102720003284' ,'12' ,'212');
testTuid('1458630000000','382371102720000000','382371102720008260' ,'32' ,'68');
testTuid('1458630000000','382371102720000000','382371102720008264' ,'32' ,'72');
testTuid('1458630000000','382371102720000000','382371102720008268' ,'32' ,'76');
testTuid('1458630000000','382371102720000000','382371102720008272' ,'32' ,'80');
testTuid('1458630000000','382371102720000000','382371102720008276' ,'32' ,'84');
testTuid('1458630000000','382371102720000000','382371102720008280' ,'32' ,'88');
testTuid('1458630000000','382371102720000000','382371102720008284' ,'32' ,'92');
testTuid('1458630000000','382371102720000000','382371102720008288' ,'32' ,'96');
testTuid('1458630000000','382371102720000000','382371102720013316' ,'52' ,'4');
testTuid('1458630000000','382371102720000000','382371102720013320' ,'52' ,'8');
testTuid('1458630000000','382371102720000000','382371102720013324' ,'52' ,'12');
testTuid('1458630000000','382371102720000000','382371102720013328' ,'52' ,'16');
testTuid('1458630000000','382371102720000000','382371102720013332' ,'52' ,'20');
testTuid('1458630000000','382371102720000000','382371102720013336' ,'52' ,'24');
testTuid('1458630000000','382371102720000000','382371102720013340' ,'52' ,'28');
testTuid('1458630000000','382371102720000000','382371102720013344' ,'52' ,'32');
testTuid('1458630000000','382371102720000000','382371102720013348' ,'52' ,'36');
testTuid('1458630000000','382371102720000000','382371102720013352' ,'52' ,'40');
testTuid('1458630000000','382371102720000000','382371102720013356' ,'52' ,'44');
testTuid('1458630000000','382371102720000000','382371102720013360' ,'52' ,'48');
testTuid('1458630000000','382371102720000000','382371102720013364' ,'52' ,'52');
testTuid('1458630000000','382371102720000000','382371102720013368' ,'52' ,'56');
testTuid('1458702678713','382390155008540672','382390155008693272' ,'596' ,'24');
testTuid('1458702678713','382390155008540672','382390155008693276' ,'596' ,'28');
testTuid('1458702678713','382390155008540672','382390155008693280' ,'596' ,'32');
testTuid('1458702678713','382390155008540672','382390155008693284' ,'596' ,'36');
testTuid('1458702678713','382390155008540672','382390155008693288' ,'596' ,'40');
testTuid('1458702678713','382390155008540672','382390155008693292' ,'596' ,'44');
testTuid('1458702678713','382390155008540672','382390155008693296' ,'596' ,'48');
testTuid('1458702678713','382390155008540672','382390155008693300' ,'596' ,'52');
testTuid('1458702678713','382390155008540672','382390155008693304' ,'596' ,'56');
testTuid('1458702678713','382390155008540672','382390155008693308' ,'596' ,'60');
testTuid('1458702678713','382390155008540672','382390155008699408' ,'620' ,'16');
testTuid('1458702678713','382390155008540672','382390155008699412' ,'620' ,'20');
testTuid('1458702678713','382390155008540672','382390155008699416' ,'620' ,'24');
testTuid('1458702678713','382390155008540672','382390155008699420' ,'620' ,'28');
testTuid('1458702678713','382390155008540672','382390155008699424' ,'620' ,'32');
testTuid('1458702678713','382390155008540672','382390155008699428' ,'620' ,'36');
testTuid('1458702678713','382390155008540672','382390155008699432' ,'620' ,'40');
testTuid('1458702678713','382390155008540672','382390155008699436' ,'620' ,'44');
testTuid('1458702678713','382390155008540672','382390155008699440' ,'620' ,'48');
testTuid('1458702678713','382390155008540672','382390155008699444' ,'620' ,'52');
testTuid('1458702678713','382390155008540672','382390155008699448' ,'620' ,'56');
testTuid('1458702678713','382390155008540672','382390155008699452' ,'620' ,'60');
testTuid('1458702678713','382390155008540672','382390155008802004' ,'1020' ,'212');
testTuid('1458702678713','382390155008540672','382390155008802008' ,'1020' ,'216');
testTuid('1458702678713','382390155008540672','382390155008802012' ,'1020' ,'220');
testTuid('1458702678713','382390155008540672','382390155008802016' ,'1020' ,'224');
testTuid('1458702678713','382390155008540672','382390155008802020' ,'1020' ,'228');
testTuid('1458702678713','382390155008540672','382390155008802024' ,'1020' ,'232');
testTuid('1458702678713','382390155008540672','382390155008802028' ,'1020' ,'236');
testTuid('1458702678713','382390155008540672','382390155008802032' ,'1020' ,'240');
testTuid('1458702678713','382390155008540672','382390155008802036' ,'1020' ,'244');
testTuid('1458702678713','382390155008540672','382390155008802040' ,'1020' ,'248');
testTuid('1458702678713','382390155008540672','382390155008802044' ,'1020' ,'252');